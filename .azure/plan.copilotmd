# Azure Deployment Plan for Pet Hospital Management System

## **Goal**
Deploy a full-stack pet hospital management application to Azure using Azure Developer CLI (AZD) with proper infrastructure provisioning and service deployment.

## **Project Information**

**Pet Hospital Management System**
- **Stack**: MERN (MongoDB, Express.js, React, Node.js)
- **Type**: Full-stack web application for pet hospital operations with real-time messaging via Socket.IO
- **Backend**: Node.js/Express REST API with Socket.IO
- **Frontend**: React SPA with React Router
- **Database**: MongoDB (will use Azure Cosmos DB with MongoDB API)
- **Real-time Features**: Socket.IO for messaging and notifications
- **Email/SMS**: Nodemailer and Twilio integration
- **AI**: OpenAI integration for chatbot functionality
- **Hosting**: Azure App Service for both frontend and backend

## **Azure Resources Architecture**

```mermaid
graph TD
%% Services
svcazureappservice_backend["`Name: backend
Path: backend
Language: js`"]
svcazureappservice_frontend["`Name: frontend
Path: frontend
Language: js`"]
subgraph "Compute Resources"
%% Resources
azureappservice_backend("`backend (Azure App Service)`")
azureappservice_frontend("`frontend (Azure App Service)`")
end
subgraph "Dependency Resources"
%% Dependency Resources
azurecosmosdb_mongodb["`mongodb (Azure Cosmos DB)`"]
end
%% Relationships
svcazureappservice_backend --> |"hosted on"| azureappservice_backend
azureappservice_backend -.-> |"secret"| azurecosmosdb_mongodb
svcazureappservice_frontend --> |"hosted on"| azureappservice_frontend
azureappservice_frontend -.-> |"http"| azureappservice_backend
```

**Architecture Relations:**
- The backend App Service connects to Azure Cosmos DB (MongoDB API) for data persistence
- The frontend App Service communicates with the backend via HTTP/HTTPS
- Application Insights monitors both services
- Key Vault stores sensitive connection strings and secrets

## **Recommended Azure Resources**

### Backend Service
- **Hosting Service Type**: Azure App Service (Linux)
- **SKU**: B2 (2 cores, 3.5 GB RAM) - suitable for production workloads with Socket.IO
- **Configuration**:
    - **Runtime**: Node.js 20 LTS
    - **Environment Variables**:
        - `PORT`: 5000
        - `NODE_ENV`: production
        - `MONGODB_URI`: (from Cosmos DB)
        - `JWT_SECRET`: (from Key Vault)
        - `FRONTEND_URL`: (frontend URL)
        - `OPENAI_API_KEY`: (from Key Vault)
        - `TWILIO_ACCOUNT_SID`: (from Key Vault)
        - `TWILIO_AUTH_TOKEN`: (from Key Vault)
        - `EMAIL_USER`: (from Key Vault)
        - `EMAIL_PASS`: (from Key Vault)
- **Dependencies**:
    - **Azure Cosmos DB for MongoDB**
        - **SKU**: Serverless (autoscaling, pay-per-use)
        - **Connection Type**: Connection String (stored in Key Vault)
        - **Environment Variable**: `MONGODB_URI`

### Frontend Service
- **Hosting Service Type**: Azure App Service (Linux)
- **SKU**: B1 (1 core, 1.75 GB RAM) - sufficient for React static serving
- **Configuration**:
    - **Runtime**: Node.js 20 LTS (for serving the built React app)
    - **Environment Variables**:
        - `REACT_APP_API_URL`: (backend URL)
        - `PORT`: 8080

## **Recommended Supporting Services**

- **Application Insights**: Monitor application performance, logs, and exceptions for both frontend and backend
- **User-Assigned Managed Identity**: For secure access to Azure resources without storing credentials
- **Log Analytics Workspace**: Centralized logging for all App Services
- **Key Vault**: Store sensitive credentials (JWT secret, Cosmos DB connection string, OpenAI API key, Twilio credentials, email credentials)

## **Recommended Security Configurations**

- User-Assigned Managed Identity must have "Key Vault Secrets User" role on the Key Vault
- User-Assigned Managed Identity must be assigned to both App Services
- Enable HTTPS only on both App Services
- Configure CORS on backend to only allow frontend origin
- Store all secrets in Key Vault with references in App Service configuration

## **Execution Steps**

> **Follow these steps sequentially. Update progress in `.azure/progress.copilotmd` after each step.**

### 1. Create Azure Infrastructure Files for AZD

1. **Provisioning tool**: AZD with Bicep
2. Retrieve subscription ID from user and call `appmod-get-available-region-sku` to find available regions and SKUs for:
   - Microsoft.Web/sites (App Service)
   - Microsoft.DocumentDB/databaseAccounts (Cosmos DB)
   - Microsoft.KeyVault/vaults
   - Microsoft.Insights/components
   - Microsoft.OperationalInsights/workspaces
3. Check if infrastructure files exist in `infra/` directory
4. If files don't exist:
   - Call `appmod-get-iac-rules` to get Bicep generation rules
   - Generate required files:
     - `azure.yaml` (AZD configuration)
     - `infra/main.bicep` (main infrastructure template)
     - `infra/main.parameters.json` (parameters)
     - `infra/resources.bicep` (resource definitions)
   - Use `get_errors` to validate generated files
5. Fix any errors in provisioning files

### 2. Environment Setup for AZD

1. Install Azure CLI and AZD if not installed
2. Run `azd auth login` to authenticate
3. Run `azd env new pet-hospital-prod --no-prompt` to create deployment environment
4. Set required environment variables:
   - `azd env set AZURE_SUBSCRIPTION_ID <user-subscription-id>`
   - `azd env set AZURE_LOCATION <selected-region>`
   - `azd env set AZURE_RESOURCE_GROUP rg-pet-hospital-prod`
5. Prompt user for secrets to configure:
   - JWT_SECRET
   - OPENAI_API_KEY
   - TWILIO_ACCOUNT_SID
   - TWILIO_AUTH_TOKEN
   - EMAIL_USER
   - EMAIL_PASS

### 3. Deployment

1. **Dry run**: Run `azd provision --preview --no-prompt` to preview infrastructure changes
2. **Provision and Deploy**: Run `azd up --no-prompt`
   - This will provision all Azure resources
   - Deploy backend service
   - Build and deploy frontend service
3. If errors occur, analyze and fix:
   - Check logs with `azd logs`
   - Fix configuration issues
   - Retry deployment
4. **Deployment Validation**:
   - Use `appmod-get-azd-app-logs` to check application logs
   - Verify backend health endpoint
   - Test frontend accessibility

### 4. Post-Deployment Configuration

1. Configure secrets in Key Vault (if not done automatically)
2. Update App Service configuration to reference Key Vault secrets
3. Restart services to apply configurations
4. Test Socket.IO connectivity
5. Verify database connectivity

### 5. Summarize Deployment Result

1. Call `appmod-summarize-result` to generate deployment summary
2. Output file: `.azure/summary.copilotmd`
3. Include:
   - Deployed service URLs
   - Resource group name
   - Database connection details
   - Next steps for the user

## **Progress Tracking**

Track progress in `.azure/progress.copilotmd` with:
- ‚úÖ Completed tasks
- üî≤ Pending tasks
- ‚ùå Failed tasks with error details and resolution steps

Example format:
```
- [x] Plan created
- [ ] Infrastructure files generation
  - Attempt 1: In progress...
- [ ] Environment setup
- [ ] Deployment
- [ ] Post-deployment configuration
- [ ] Summary generation
```

## **Tools Checklist**

- [ ] appmod-get-available-region-sku
- [ ] appmod-get-iac-rules
- [ ] appmod-get-azd-app-logs
- [ ] appmod-summarize-result
